# Firestore Collections & Data Structure Analysis

## Overview
This document provides a comprehensive analysis of all Firestore collections in the Zenda School Attendance System, including their data structures, relationships, and usage patterns.

## Collection Status Summary

**Active Collections (Used in Codebase):**
- âœ… students
- âœ… messages
- âœ… api_logs
- âœ… fingerprints

**Existing Collections (In Firestore, Not Yet Used in Code):**
- ğŸ“¦ classes
- ğŸ“¦ devices
- ğŸ“¦ parents
- ğŸ“¦ schools
- ğŸ“¦ sessions
- ğŸ“¦ system
- ğŸ“¦ teachers
- ğŸ“¦ users
- ğŸ“¦ workers

---

## 1. **students** Collection

### Purpose
Stores student information including personal details, parent contacts, address, fingerprint data, and attendance history.

### Document Structure
```typescript
{
  // Document ID: Auto-generated by Firestore
  
  // Basic Information
  name: string (required)
  period: string (required) // "Morning" | "Afternoon"
  registrationNumber?: string
  gender?: string
  birthdate?: string // ISO 8601 format
  
  // Parent Information
  fatherName?: string
  fatherPhone?: string // Used for parent login queries
  motherName?: string
  motherPhone?: string // Used for parent login queries
  
  // Address Information
  country?: string
  province?: string
  district?: string
  sector?: string
  cell?: string
  
  // Fingerprint Data
  fingerprintData?: string // Base64 encoded fingerprint
  fingerprintTimestamp?: string // ISO 8601 format
  
  // Attendance History (Array of objects)
  attendanceHistory: [
    {
      date: string, // ISO 8601 format
      status: "present" | "late" | "absent" | "unknown"
    }
  ]
  
  // Metadata
  createdAt?: string // ISO 8601 format (auto-added on creation)
}
```

### Key Fields & Usage
- **fatherPhone** / **motherPhone**: Used to query students by parent phone number for parent login
- **attendanceHistory**: Array stored within document (not subcollection)
- **fingerprintData**: Base64 encoded fingerprint sample from scanner

### Queries Used
1. Get all students: `collection('students').get()`
2. Get by father phone: `collection('students').where('fatherPhone', isEqualTo: phone)`
3. Get by mother phone: `collection('students').where('motherPhone', isEqualTo: phone)`
4. Update attendance: Updates `attendanceHistory` array within document

### Indexes Required
- `schoolId` + `name` + `__name__` (ASC) - For future multi-school support
- Single field indexes on `fatherPhone` and `motherPhone` (implicit)

---

## 2. **messages** Collection

### Purpose
Stores chat messages between school administrators and parents for each student.

### Document Structure
```typescript
{
  // Document ID: Auto-generated by Firestore
  
  studentId: string (required) // Reference to students collection document ID
  content: string (required) // Message text content
  timestamp: Timestamp (required) // Server timestamp
  sender: "school" | "parent" (required)
  isRead: boolean (default: false)
  senderName?: string // Display name of sender
  attachmentUrl?: string // URL to attached file/image
}
```

### Key Fields & Usage
- **studentId**: Links message to a specific student
- **sender**: Determines if message is from school or parent
- **isRead**: Tracks read status for unread message counts
- **timestamp**: Used for ordering messages chronologically

### Queries Used
1. Get messages for student: 
   ```dart
   collection('messages')
     .where('studentId', isEqualTo: studentId)
     .orderBy('timestamp', descending: true)
   ```

2. Get unread count:
   ```dart
   collection('messages')
     .where('studentId', isEqualTo: studentId)
     .where('sender', isEqualTo: 'parent') // or 'school'
     .where('isRead', isEqualTo: false)
   ```

3. Get all unread messages:
   ```dart
   collection('messages')
     .where('sender', isEqualTo: 'parent') // or 'school'
     .where('isRead', isEqualTo: false)
   ```

### Indexes Required
- `studentId` (ASC) + `timestamp` (DESC)
- `studentId` (ASC) + `sender` (ASC) + `isRead` (ASC)
- `sender` (ASC) + `isRead` (ASC)
- Variants with `__name__` for document ID sorting

---

## 3. **api_logs** Collection

### Purpose
Logs API calls, authentication attempts, and fingerprint scanning events for monitoring and debugging.

### Document Structure
```typescript
{
  // Document ID: Auto-generated by Firestore
  
  studentId: string (required) // Student involved in the operation
  studentName?: string // Cached student name for display
  success: boolean (required) // Whether operation succeeded
  timestamp: Timestamp (required) // Server timestamp
  deviceId?: string // Device identifier
  errorMessage?: string // Error details if success = false
  type: string (default: "authentication") // "authentication" | "fingerprint" | etc.
}
```

### Key Fields & Usage
- **success**: Used for filtering successful vs failed operations
- **type**: Categorizes log entries (authentication, fingerprint, etc.)
- **timestamp**: Used for chronological ordering
- **studentId**: Links log to specific student

### Queries Used
1. Get logs with filters:
   ```dart
   collection('api_logs')
     .orderBy('timestamp', descending: true)
     .limit(100)
     // Optional filters:
     .where('success', isEqualTo: true/false)
     .where('type', isEqualTo: 'fingerprint' | 'authentication')
   ```

### Indexes Required
- `success` (ASC) + `timestamp` (DESC)
- `type` (ASC) + `timestamp` (DESC)
- `success` (ASC) + `type` (ASC) + `timestamp` (DESC)

---

## 4. **fingerprints** Collection

### Purpose
Temporary collection used for real-time fingerprint scanning. The fingerprint scanner writes to this collection, and the app listens for new entries.

### Document Structure
```typescript
{
  // Document ID: Auto-generated by Firestore
  
  fingerprint_sample: string (required) // Base64 encoded fingerprint data
  timestamp: Timestamp (required) // When fingerprint was captured
  // Additional fields may exist depending on scanner implementation
}
```

### Key Fields & Usage
- **fingerprint_sample**: The actual fingerprint data in base64 format
- **timestamp**: Used to determine if fingerprint is newer than scan start time

### Queries Used
1. Listen for latest fingerprint:
   ```dart
   collection('fingerprints')
     .orderBy('timestamp', descending: true)
     .limit(1)
     .snapshots()
   ```

### Workflow
1. App starts fingerprint scan and records start timestamp
2. Scanner device writes fingerprint to `fingerprints` collection
3. App listens for new documents with timestamp after start time
4. When found, app copies `fingerprint_sample` to student document
5. Fingerprint data is stored in `students` collection, not kept in `fingerprints`

### Indexes Required
- `timestamp` (DESC) - Single field index (implicit)

---

## 5. **sessions** Collection

### Purpose
*Exists in Firestore but not yet implemented in codebase. Used for managing school sessions/periods.*

### Expected Document Structure
```typescript
{
  // Document ID: Auto-generated by Firestore
  
  schoolId: string (required) // Multi-school support
  date: Timestamp | string (required) // Session date
  isActive: boolean // Whether session is currently active
  // Additional fields likely:
  // - startTime, endTime
  // - period (Morning/Afternoon)
  // - classId or className
  // - teacherId
}
```

### Indexes Defined (Not Yet Used)
- `schoolId` (ASC) + `date` (ASC) + `__name__` (ASC)
- `isActive` (ASC) + `date` (ASC) + `__name__` (ASC)
- `schoolId` (ASC) + `date` (DESC) + `__name__` (DESC)

---

## 6. **teachers** Collection

### Purpose
*Exists in Firestore but not yet implemented in codebase. Used for teacher management.*

### Expected Document Structure
```typescript
{
  // Document ID: Auto-generated by Firestore
  
  schoolId: string (required) // Multi-school support
  name: string (required) // Teacher name
  // Additional fields likely:
  // - email, phone
  // - subject, classId
  // - employeeId
}
```

### Indexes Defined (Not Yet Used)
- `schoolId` (ASC) + `name` (ASC) + `__name__` (DESC)

---

## 7. **classes** Collection

### Purpose
*Exists in Firestore but not yet implemented in codebase. Used for class/grade management.*

### Expected Document Structure
```typescript
{
  // Document ID: Auto-generated by Firestore
  
  schoolId: string (required) // Multi-school support
  name: string (required) // Class name (e.g., "Grade 1A", "Form 3B")
  // Additional fields likely:
  // - grade, level
  // - teacherId
  // - studentIds[]
}
```

### Indexes Defined (Not Yet Used)
- `schoolId` (ASC) + `name` (ASC) + `__name__` (ASC)

---

## 8. **devices** Collection

### Purpose
*Exists in Firestore but not yet implemented in codebase. Likely used for managing fingerprint scanner devices and other hardware.*

### Expected Document Structure
```typescript
{
  // Document ID: Auto-generated by Firestore
  
  deviceId: string (required) // Unique device identifier
  deviceName?: string // Human-readable device name
  deviceType?: string // "fingerprint_scanner" | "attendance_terminal" | etc.
  schoolId?: string // Associated school
  isActive?: boolean // Whether device is currently active
  lastSeen?: Timestamp // Last communication timestamp
  // Additional fields likely:
  // - location, room
  // - firmwareVersion
  // - status, errorLog
  // - registeredAt
}
```

### Potential Usage
- Track fingerprint scanner devices
- Monitor device health and connectivity
- Associate devices with specific schools/locations
- Log device events and errors

---

## 9. **parents** Collection

### Purpose
*Exists in Firestore but not yet implemented in codebase. Likely used for managing parent accounts and information separately from student records.*

### Expected Document Structure
```typescript
{
  // Document ID: Auto-generated by Firestore
  
  phone: string (required) // Primary phone number (used for login)
  name?: string // Parent name
  email?: string // Email address
  relationship?: string // "father" | "mother" | "guardian"
  studentIds?: string[] // Array of student document IDs
  // Additional fields likely:
  // - address
  // - createdAt, lastLogin
  // - notificationPreferences
  // - profilePicture
}
```

### Potential Usage
- Separate parent accounts from student records
- Manage parent authentication
- Store parent preferences and settings
- Link multiple students to one parent account

---

## 10. **schools** Collection

### Purpose
*Exists in Firestore but not yet implemented in codebase. Used for multi-school support and school configuration.*

### Expected Document Structure
```typescript
{
  // Document ID: Auto-generated by Firestore
  
  name: string (required) // School name
  code?: string // School code/identifier
  address?: {
    country?: string
    province?: string
    district?: string
    sector?: string
    cell?: string
  }
  contact?: {
    phone?: string
    email?: string
  }
  // Additional fields likely:
  // - logo, website
  // - settings, configuration
  // - createdAt, isActive
  // - adminIds[]
}
```

### Potential Usage
- Multi-tenant support for multiple schools
- School-specific configuration
- School branding and settings
- Admin user management per school

---

## 11. **system** Collection

### Purpose
*Exists in Firestore but not yet implemented in codebase. Likely used for system-wide configuration and settings.*

### Expected Document Structure
```typescript
{
  // Document ID: Auto-generated or specific keys (e.g., "config", "settings")
  
  // Could be a single document or multiple documents
  // Example structure:
  version?: string // System version
  maintenanceMode?: boolean
  features?: {
    fingerprintEnabled?: boolean
    messagingEnabled?: boolean
    // Feature flags
  }
  settings?: {
    attendancePeriods?: string[] // ["Morning", "Afternoon"]
    defaultCountry?: string
    // Global settings
  }
  // Additional fields likely:
  // - lastBackup, lastMaintenance
  // - notifications, alerts
}
```

### Potential Usage
- System-wide configuration
- Feature flags and toggles
- Maintenance mode control
- Global settings management

---

## 12. **users** Collection

### Purpose
*Exists in Firestore but not yet implemented in codebase. Likely used for managing admin and staff user accounts.*

### Expected Document Structure
```typescript
{
  // Document ID: Auto-generated by Firestore
  
  email: string (required) // Used for Firebase Auth
  name?: string // User's full name
  role?: string // "admin" | "teacher" | "staff" | etc.
  schoolId?: string // Associated school
  phone?: string // Contact phone
  // Additional fields likely:
  // - createdAt, lastLogin
  // - permissions, accessLevel
  // - isActive, isEmailVerified
  // - profilePicture
}
```

### Potential Usage
- Admin user management
- Role-based access control
- User authentication (Firebase Auth integration)
- Staff and teacher accounts

---

## 13. **workers** Collection

### Purpose
*Exists in Firestore but not yet implemented in codebase. May be an alternative or legacy name for students, or used for staff/employee management.*

### Expected Document Structure
```typescript
{
  // Document ID: Auto-generated by Firestore
  
  // Could be similar to students structure:
  name: string (required)
  employeeId?: string // If used for staff
  schoolId?: string
  // Or could be legacy/alternative to students:
  // Similar fields to students collection
  // - name, period, registrationNumber
  // - attendanceHistory
  // - fingerprintData
}
```

### Potential Usage
- Alternative naming for students (legacy)
- Staff/employee management
- Worker attendance tracking (if different from students)
- Employee records

---

## Collection Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   schools   â”‚ (Multi-tenant root)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ schoolId
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚              â”‚              â”‚              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚  students   â”‚ â”‚ teachers  â”‚ â”‚  classes  â”‚ â”‚ sessions  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ studentId
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚              â”‚              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚  messages   â”‚ â”‚ api_logs  â”‚ â”‚  parents  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                     â”‚ phone
                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚  devices    â”‚              â”‚    users     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ deviceId
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚fingerprints â”‚ (temporary)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   system    â”‚ (Global config)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   workers   â”‚ (Legacy/Alternative)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Patterns

### 1. Student Creation Flow
```
User Input â†’ Student Form â†’ FirebaseService.addStudent()
  â†’ Firestore: students/{docId}
  â†’ Returns document ID
```

### 2. Attendance Recording Flow
```
Admin selects student & date â†’ FirebaseService.recordAttendance()
  â†’ Reads students/{studentId}
  â†’ Updates attendanceHistory array
  â†’ Writes back to students/{studentId}
```

### 3. Parent Login Flow
```
Parent enters phone â†’ FirebaseService.getStudentsByParentPhone()
  â†’ Query: students.where('fatherPhone' | 'motherPhone')
  â†’ Returns matching students
```

### 4. Message Flow
```
User sends message â†’ FirebaseService.sendMessage()
  â†’ Creates: messages/{docId}
  â†’ Real-time listener: messages.where('studentId')
  â†’ Updates UI via Stream
```

### 5. Fingerprint Scanning Flow
```
Start scan â†’ Listen: fingerprints.orderBy('timestamp').limit(1)
  â†’ Scanner writes: fingerprints/{docId}
  â†’ App detects new document
  â†’ Copy fingerprint_sample to students/{studentId}.fingerprintData
```

---

## Security Rules Analysis

**Current Rules**: `firestore.rules`
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true; // âš ï¸ OPEN ACCESS - For development only
    }
  }
}
```

**âš ï¸ Security Warning**: Current rules allow full read/write access to all collections. This should be restricted in production.

### Recommended Production Rules
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Students - Admins can read/write, parents can read their children
    match /students/{studentId} {
      allow read: if request.auth != null && 
        (isAdmin() || isParentOfStudent(studentId));
      allow write: if request.auth != null && isAdmin();
    }
    
    // Messages - Participants can read/write
    match /messages/{messageId} {
      allow read: if request.auth != null && 
        (isAdmin() || isParentOfStudent(resource.data.studentId));
      allow create: if request.auth != null;
      allow update: if request.auth != null && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);
    }
    
    // API Logs - Admins only
    match /api_logs/{logId} {
      allow read, write: if request.auth != null && isAdmin();
    }
    
    // Fingerprints - Write only from scanner, read by admins
    match /fingerprints/{fingerprintId} {
      allow write: if true; // Scanner device writes
      allow read: if request.auth != null && isAdmin();
    }
  }
  
  function isAdmin() {
    return request.auth.token.admin == true;
  }
  
  function isParentOfStudent(studentId) {
    let student = get(/databases/$(database)/documents/students/$(studentId));
    return request.auth.token.phone == student.data.fatherPhone || 
           request.auth.token.phone == student.data.motherPhone;
  }
}
```

---

## Index Summary

### Active Indexes (Currently Used)
1. **messages**: `studentId` + `timestamp` (DESC)
2. **messages**: `studentId` + `sender` + `isRead`
3. **messages**: `sender` + `isRead`
4. **api_logs**: `success` + `timestamp` (DESC)
5. **api_logs**: `type` + `timestamp` (DESC)
6. **api_logs**: `success` + `type` + `timestamp` (DESC)

### Planned Indexes (Not Yet Used)
1. **sessions**: `schoolId` + `date` + `__name__`
2. **sessions**: `isActive` + `date` + `__name__`
3. **students**: `schoolId` + `name` + `__name__`
4. **teachers**: `schoolId` + `name` + `__name__`
5. **classes**: `schoolId` + `name` + `__name__`

### Collections Without Indexes Defined
- **devices** - May need indexes for `schoolId`, `deviceType`, `isActive`
- **parents** - May need indexes for `phone`, `studentIds`
- **schools** - May need indexes for `code`, `isActive`
- **system** - Typically single document, may not need indexes
- **users** - May need indexes for `email`, `schoolId`, `role`
- **workers** - Structure depends on usage (may mirror students)

---

## Recommendations

### High Priority
1. **Update security rules** - Current rules allow full access, need role-based permissions
2. **Add schoolId to students collection** - Currently missing but indexed, needed for multi-school support
3. **Implement missing collections in codebase** - Several collections exist in Firestore but aren't used:
   - `schools` - Multi-tenant support
   - `users` - Admin/staff management
   - `parents` - Separate parent accounts
   - `devices` - Device management
   - `sessions`, `teachers`, `classes` - Already indexed, ready for implementation

### Medium Priority
4. **Add data validation** - Consider Cloud Functions for data validation
5. **Add indexes for fatherPhone/motherPhone** - Currently using implicit indexes
6. **Define indexes for new collections** - Add indexes for `devices`, `parents`, `users` collections
7. **Clarify workers collection** - Determine if it's legacy, alternative to students, or for staff

### Low Priority
8. **Consider subcollections** - Move `attendanceHistory` to subcollection for better scalability
9. **Implement system collection** - Global configuration and feature flags
10. **Document collection relationships** - Create clear foreign key relationships

---

## Notes

- All timestamps use Firestore `Timestamp` type or ISO 8601 strings
- Phone numbers are normalized (remove +250 prefix) before queries
- Attendance history is stored as array within student document (not subcollection)
- Fingerprint data is base64 encoded string
- Multi-school support (`schoolId`) exists in Firestore but not fully implemented in codebase
- Several collections exist in Firestore but are not yet referenced in the application code
- The `workers` collection may be legacy or an alternative naming convention
- The `system` collection likely contains global configuration as a single document or few documents

